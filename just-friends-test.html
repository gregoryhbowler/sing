<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Just Friends - Complete Module Emulation</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;500;600&display=swap');
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    :root {
      --bg-dark: #0a0a0b;
      --bg-panel: #141416;
      --bg-control: #1c1c20;
      --border: #2a2a30;
      --text: #e8e8ec;
      --text-dim: #888890;
      --accent: #f0c040;
      --accent-dim: #a08020;
      --trigger: #40f080;
      --gate: #4080f0;
      --run: #f04080;
    }
    
    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }
    
    h1 {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: -0.5px;
    }
    
    .status-bar {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-dim);
      background: var(--bg-control);
      padding: 8px 12px;
      border-radius: 4px;
    }
    
    .main-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    button {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg-control);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.15s;
    }
    
    button:hover {
      background: var(--border);
    }
    
    button.primary {
      background: var(--accent);
      color: var(--bg-dark);
      border-color: var(--accent);
    }
    
    button.primary:hover {
      background: var(--accent-dim);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .panel-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-dim);
    }
    
    .mode-badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      background: var(--accent);
      color: var(--bg-dark);
      padding: 4px 8px;
      border-radius: 3px;
    }
    
    .mode-badge.run {
      background: var(--run);
    }
    
    /* Scope */
    .scope-container {
      background: #000;
      border-radius: 4px;
      overflow: hidden;
    }
    
    canvas {
      display: block;
      width: 100%;
      height: 120px;
    }
    
    /* Mode Selection */
    .mode-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
      background: var(--border);
      border-radius: 6px;
      overflow: hidden;
    }
    
    .mode-btn {
      background: var(--bg-control);
      border: none;
      padding: 12px 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .mode-btn:hover {
      background: var(--border);
    }
    
    .mode-btn.active {
      background: var(--accent);
      color: var(--bg-dark);
    }
    
    .mode-btn .mode-name {
      display: block;
      font-size: 12px;
      font-weight: 600;
    }
    
    .mode-btn .run-name {
      display: block;
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 2px;
    }
    
    .mode-btn.active .run-name {
      color: var(--bg-dark);
      opacity: 0.7;
    }
    
    .range-toggle {
      display: flex;
      gap: 2px;
      background: var(--border);
      border-radius: 6px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .range-btn {
      flex: 1;
      background: var(--bg-control);
      border: none;
      padding: 10px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .range-btn:hover {
      background: var(--border);
    }
    
    .range-btn.active {
      background: var(--accent);
      color: var(--bg-dark);
    }
    
    /* RUN Mode Toggle */
    .run-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
    }
    
    .run-toggle label {
      font-size: 12px;
      color: var(--text-dim);
    }
    
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--bg-control);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .toggle-switch.active {
      background: var(--run);
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: var(--text);
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.2s;
    }
    
    .toggle-switch.active::after {
      transform: translateX(20px);
    }
    
    /* Knobs */
    .knobs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 20px;
    }
    
    .knob-container {
      text-align: center;
    }
    
    .knob-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-dim);
      margin-bottom: 10px;
    }
    
    .knob-wrapper {
      position: relative;
      width: 80px;
      height: 80px;
      margin: 0 auto;
    }
    
    .knob {
      width: 100%;
      height: 100%;
      background: linear-gradient(145deg, #2a2a30, #1a1a1e);
      border-radius: 50%;
      border: 2px solid var(--border);
      cursor: grab;
      position: relative;
    }
    
    .knob::after {
      content: '';
      position: absolute;
      width: 3px;
      height: 20px;
      background: var(--accent);
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 2px;
    }
    
    .knob-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--accent);
      margin-top: 8px;
    }
    
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: var(--bg-control);
      border-radius: 3px;
      margin: 10px 0;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }
    
    /* Trigger Buttons */
    .triggers-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
    }
    
    .trigger-col {
      text-align: center;
    }
    
    .trigger-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 8px;
    }
    
    .trigger-btn {
      width: 100%;
      aspect-ratio: 1;
      background: var(--bg-control);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }
    
    .trigger-btn:hover {
      border-color: var(--trigger);
    }
    
    .trigger-btn:active,
    .trigger-btn.active {
      background: var(--trigger);
      border-color: var(--trigger);
      color: var(--bg-dark);
    }
    
    .trigger-btn.gate-mode:active,
    .trigger-btn.gate-mode.active {
      background: var(--gate);
      border-color: var(--gate);
    }
    
    .output-indicator {
      width: 8px;
      height: 8px;
      background: var(--bg-control);
      border-radius: 50%;
      margin: 8px auto;
      transition: all 0.05s;
    }
    
    .output-indicator.active {
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
    }
    
    /* Output Selection */
    .output-select {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    
    .output-btn {
      padding: 6px 12px;
      font-size: 11px;
      background: var(--bg-control);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
    }
    
    .output-btn:hover {
      border-color: var(--accent);
    }
    
    .output-btn.active {
      background: var(--accent);
      color: var(--bg-dark);
      border-color: var(--accent);
    }
    
    /* Presets */
    .presets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
    }
    
    .preset-btn {
      padding: 8px;
      font-size: 11px;
      background: var(--bg-control);
      border: 1px solid var(--border);
    }
    
    /* Layout */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    
    @media (max-width: 768px) {
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }
    }
    
    /* Info text */
    .info-text {
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.5;
      margin-top: 10px;
    }
    
    .info-text strong {
      color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Just Friends</h1>
      <div class="status-bar" id="status">Click Start to begin</div>
    </header>
    
    <div class="main-controls">
      <button class="primary" id="startBtn">▶ Start Audio</button>
      <button id="stopBtn" disabled>■ Stop</button>
    </div>
    
    <!-- Scope -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Waveform</span>
        <span class="mode-badge" id="modeBadge">CYCLE/SOUND</span>
      </div>
      <div class="scope-container">
        <canvas id="scope"></canvas>
      </div>
      <div style="margin-top: 15px;">
        <div class="panel-title" style="margin-bottom: 8px;">Monitor Output</div>
        <div class="output-select" id="outputSelect">
          <button class="output-btn active" data-output="6">MIX</button>
          <button class="output-btn" data-output="0">1N</button>
          <button class="output-btn" data-output="1">2N</button>
          <button class="output-btn" data-output="2">3N</button>
          <button class="output-btn" data-output="3">4N</button>
          <button class="output-btn" data-output="4">5N</button>
          <button class="output-btn" data-output="5">6N</button>
        </div>
      </div>
    </div>
    
    <div class="grid-2">
      <!-- Mode Selection -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Mode</span>
        </div>
        <div class="mode-grid" id="modeGrid">
          <button class="mode-btn" data-mode="0">
            <span class="mode-name">TRANSIENT</span>
            <span class="run-name">SHIFT / SPILL</span>
          </button>
          <button class="mode-btn" data-mode="1">
            <span class="mode-name">SUSTAIN</span>
            <span class="run-name">STRATA / PLUME</span>
          </button>
          <button class="mode-btn active" data-mode="2">
            <span class="mode-name">CYCLE</span>
            <span class="run-name">VOLLEY / FLOOM</span>
          </button>
        </div>
        <div class="range-toggle" id="rangeToggle">
          <button class="range-btn" data-range="0">SHAPE (LFO/ENV)</button>
          <button class="range-btn active" data-range="1">SOUND (VCO)</button>
        </div>
        <div class="run-toggle">
          <label>RUN Mode</label>
          <div class="toggle-switch" id="runToggle"></div>
          <span id="runModeName" style="font-size: 12px; color: var(--run);">FLOOM</span>
        </div>
        <p class="info-text" id="modeInfo">
          <strong>CYCLE/SOUND:</strong> Free-running waveshaped VCOs. 
          TIME controls pitch, INTONE spreads harmonics.
        </p>
      </div>
      
      <!-- Triggers -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Triggers / Gates</span>
          <select id="triggerMode" style="background: var(--bg-control); color: var(--text); border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; font-size: 11px;">
            <option value="trigger">Trigger (click)</option>
            <option value="gate">Gate (hold)</option>
          </select>
        </div>
        <div class="triggers-grid">
          <div class="trigger-col">
            <div class="trigger-label">1N</div>
            <button class="trigger-btn" data-index="0">TRIG</button>
            <div class="output-indicator" data-ind="0"></div>
          </div>
          <div class="trigger-col">
            <div class="trigger-label">2N</div>
            <button class="trigger-btn" data-index="1">TRIG</button>
            <div class="output-indicator" data-ind="1"></div>
          </div>
          <div class="trigger-col">
            <div class="trigger-label">3N</div>
            <button class="trigger-btn" data-index="2">TRIG</button>
            <div class="output-indicator" data-ind="2"></div>
          </div>
          <div class="trigger-col">
            <div class="trigger-label">4N</div>
            <button class="trigger-btn" data-index="3">TRIG</button>
            <div class="output-indicator" data-ind="3"></div>
          </div>
          <div class="trigger-col">
            <div class="trigger-label">5N</div>
            <button class="trigger-btn" data-index="4">TRIG</button>
            <div class="output-indicator" data-ind="4"></div>
          </div>
          <div class="trigger-col">
            <div class="trigger-label">6N</div>
            <button class="trigger-btn" data-index="5">TRIG</button>
            <div class="output-indicator" data-ind="5"></div>
          </div>
        </div>
        <p class="info-text" style="margin-top: 15px;">
          Triggers are normalled: 6N cascades to all. In SUSTAIN mode, use Gate mode for ASR envelopes.
        </p>
      </div>
    </div>
    
    <!-- Main Knobs -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Parameters</span>
      </div>
      <div class="knobs-grid">
        <div class="knob-container">
          <div class="knob-label">TIME</div>
          <input type="range" id="time" min="0" max="1" step="0.001" value="0.5">
          <div class="knob-value" id="timeVal">0.500</div>
        </div>
        <div class="knob-container">
          <div class="knob-label">INTONE</div>
          <input type="range" id="intone" min="0" max="1" step="0.001" value="0.5">
          <div class="knob-value" id="intoneVal">0.500</div>
        </div>
        <div class="knob-container">
          <div class="knob-label">RAMP</div>
          <input type="range" id="ramp" min="0" max="1" step="0.001" value="0.5">
          <div class="knob-value" id="rampVal">0.500</div>
        </div>
        <div class="knob-container">
          <div class="knob-label">CURVE</div>
          <input type="range" id="curve" min="0" max="1" step="0.001" value="0.5">
          <div class="knob-value" id="curveVal">0.500</div>
        </div>
        <div class="knob-container">
          <div class="knob-label">FM INDEX</div>
          <input type="range" id="fmIndex" min="-1" max="1" step="0.001" value="0">
          <div class="knob-value" id="fmIndexVal">0.000</div>
        </div>
        <div class="knob-container">
          <div class="knob-label">RUN</div>
          <input type="range" id="run" min="-1" max="1" step="0.001" value="0">
          <div class="knob-value" id="runVal">0.000</div>
        </div>
        <div class="knob-container">
          <div class="knob-label">VOLUME</div>
          <input type="range" id="volume" min="0" max="1" step="0.001" value="0.2">
          <div class="knob-value" id="volumeVal">0.200</div>
        </div>
      </div>
    </div>
    
    <!-- Presets -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Presets</span>
      </div>
      <div class="grid-3">
        <div>
          <div style="font-size: 11px; color: var(--text-dim); margin-bottom: 8px;">WAVESHAPE</div>
          <div class="presets-grid">
            <button class="preset-btn" onclick="presetSine()">Sine</button>
            <button class="preset-btn" onclick="presetTriangle()">Triangle</button>
            <button class="preset-btn" onclick="presetSaw()">Saw</button>
            <button class="preset-btn" onclick="presetSquare()">Square</button>
          </div>
        </div>
        <div>
          <div style="font-size: 11px; color: var(--text-dim); margin-bottom: 8px;">INTONE</div>
          <div class="presets-grid">
            <button class="preset-btn" onclick="setParam('intone', 0)">Undertones</button>
            <button class="preset-btn" onclick="setParam('intone', 0.5)">Unison</button>
            <button class="preset-btn" onclick="setParam('intone', 1)">Overtones</button>
          </div>
        </div>
        <div>
          <div style="font-size: 11px; color: var(--text-dim); margin-bottom: 8px;">PATCHES</div>
          <div class="presets-grid">
            <button class="preset-btn" onclick="presetFMBass()">FM Bass</button>
            <button class="preset-btn" onclick="presetChord()">Chord</button>
            <button class="preset-btn" onclick="presetNoise()">Noise</button>
            <button class="preset-btn" onclick="presetPlucks()">Plucks</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { JustFriendsOscNode } from './JustFriendsOscNode.js';
    
    let ctx = null;
    let jf = null;
    let masterGain = null;
    let analyser = null;
    let animationId = null;
    let currentOutput = 6;
    let currentMode = 2;
    let currentRange = 1;
    let runEnabled = false;
    let triggerMode = 'trigger';
    
    const canvas = document.getElementById('scope');
    const canvasCtx = canvas.getContext('2d');
    
    // Mode descriptions
    const modeInfo = {
      '0/0': '<strong>TRANSIENT/SHAPE:</strong> AR envelope generators. Triggers start attack phase, ignored while active.',
      '1/0': '<strong>SUSTAIN/SHAPE:</strong> ASR envelope generators. Gate-sensitive with "vactrol memory" effect.',
      '2/0': '<strong>CYCLE/SHAPE:</strong> LFOs with controllable phase relationships. Triggers reset phase.',
      '0/1': '<strong>TRANSIENT/SOUND:</strong> Impulse-train VCOs. Pitch from trigger rate, TIME/INTONE control formant.',
      '1/1': '<strong>SUSTAIN/SOUND:</strong> Trapezoid VCOs. Tracks PWM of input gate.',
      '2/1': '<strong>CYCLE/SOUND:</strong> Free-running waveshaped VCOs. TIME controls pitch, INTONE spreads harmonics.',
      '0/0/run': '<strong>SHIFT:</strong> AR envelopes with retrigger control. RUN sets retrigger point.',
      '1/0/run': '<strong>STRATA:</strong> ARSR envelopes. RUN controls sustain level. Can be used as slew limiter.',
      '2/0/run': '<strong>VOLLEY:</strong> Modulation burst generator. RUN controls burst count (1-36 cycles).',
      '0/1/run': '<strong>SPILL:</strong> Self-clocked impulse trains with sync chaos. IDENTITY clocks others.',
      '1/1/run': '<strong>PLUME:</strong> LPG-processed VCOs. Pluck/hold gates, major/minor chords via INTONE.',
      '2/1/run': '<strong>FLOOM:</strong> 2-operator FM synthesis. RUN controls mod:carrier ratio. Can generate noise.'
    };
    
    const runModeNames = {
      '0/0': 'SHIFT',
      '1/0': 'STRATA', 
      '2/0': 'VOLLEY',
      '0/1': 'SPILL',
      '1/1': 'PLUME',
      '2/1': 'FLOOM'
    };
    
    function updateModeDisplay() {
      const rangeNames = ['SHAPE', 'SOUND'];
      const modeNames = ['TRANSIENT', 'SUSTAIN', 'CYCLE'];
      let badge = `${modeNames[currentMode]}/${rangeNames[currentRange]}`;
      
      const runName = runModeNames[`${currentMode}/${currentRange}`];
      document.getElementById('runModeName').textContent = runName;
      
      if (runEnabled) {
        badge = runName;
        document.getElementById('modeBadge').classList.add('run');
      } else {
        document.getElementById('modeBadge').classList.remove('run');
      }
      
      document.getElementById('modeBadge').textContent = badge;
      
      const infoKey = runEnabled ? `${currentMode}/${currentRange}/run` : `${currentMode}/${currentRange}`;
      document.getElementById('modeInfo').innerHTML = modeInfo[infoKey] || '';
    }
    
    function selectOutput(index) {
      if (!jf || !analyser) return;
      
      // Disconnect all
      for (let i = 0; i <= 6; i++) {
        try { jf.getOutput(i).disconnect(analyser); } catch(e) {}
      }
      
      jf.getOutput(index).connect(analyser);
      currentOutput = index;
      
      document.querySelectorAll('.output-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.output) === index);
      });
    }
    
    async function startAudio() {
      try {
        ctx = new AudioContext();
        document.getElementById('status').textContent = 'Loading...';
        
        await ctx.audioWorklet.addModule('./just-friends-osc-processor.js');
        
        jf = new JustFriendsOscNode(ctx);
        jf.setCycleSoundMode();
        
        masterGain = ctx.createGain();
        masterGain.gain.value = parseFloat(document.getElementById('volume').value);
        
        analyser = ctx.createAnalyser();
        analyser.fftSize = 2048;
        
        jf.getOutput(currentOutput).connect(analyser);
        analyser.connect(masterGain);
        masterGain.connect(ctx.destination);
        
        // Apply initial values
        applyAllParams();
        
        await ctx.resume();
        
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        document.getElementById('status').textContent = `Running @ ${ctx.sampleRate}Hz`;
        
        drawScope();
        
      } catch (err) {
        document.getElementById('status').textContent = `Error: ${err.message}`;
        console.error(err);
      }
    }
    
    function stopAudio() {
      if (ctx) {
        ctx.close();
        ctx = null;
        jf = null;
      }
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      document.getElementById('status').textContent = 'Stopped';
      
      canvasCtx.fillStyle = '#000';
      canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
    }
    
    function applyAllParams() {
      if (!jf) return;
      
      jf.params.time.value = parseFloat(document.getElementById('time').value);
      jf.params.intone.value = parseFloat(document.getElementById('intone').value);
      jf.params.ramp.value = parseFloat(document.getElementById('ramp').value);
      jf.params.curve.value = parseFloat(document.getElementById('curve').value);
      jf.params.fmIndex.value = parseFloat(document.getElementById('fmIndex').value);
      jf.params.run.value = parseFloat(document.getElementById('run').value);
      jf.params.range.value = currentRange;
      jf.params.mode.value = currentMode;
      jf.params.runEnabled.value = runEnabled ? 1 : 0;
    }
    
    function drawScope() {
      if (!analyser) return;
      
      animationId = requestAnimationFrame(drawScope);
      
      const bufferLength = analyser.fftSize;
      const dataArray = new Float32Array(bufferLength);
      analyser.getFloatTimeDomainData(dataArray);
      
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      
      const width = rect.width;
      const height = rect.height;
      
      canvasCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      
      canvasCtx.fillStyle = '#000';
      canvasCtx.fillRect(0, 0, width, height);
      
      // Grid lines
      canvasCtx.strokeStyle = '#1a1a1a';
      canvasCtx.lineWidth = 1;
      for (let y = 0; y <= 4; y++) {
        canvasCtx.beginPath();
        canvasCtx.moveTo(0, y * height / 4);
        canvasCtx.lineTo(width, y * height / 4);
        canvasCtx.stroke();
      }
      
      // Center line
      canvasCtx.strokeStyle = '#333';
      canvasCtx.beginPath();
      canvasCtx.moveTo(0, height / 2);
      canvasCtx.lineTo(width, height / 2);
      canvasCtx.stroke();
      
      // Waveform
      canvasCtx.strokeStyle = '#f0c040';
      canvasCtx.lineWidth = 1.5;
      canvasCtx.beginPath();
      
      const sliceWidth = width / bufferLength;
      let x = 0;
      
      for (let i = 0; i < bufferLength; i++) {
        const v = dataArray[i];
        const y = (1 - v) * height / 2;
        
        if (i === 0) {
          canvasCtx.moveTo(x, y);
        } else {
          canvasCtx.lineTo(x, y);
        }
        x += sliceWidth;
      }
      
      canvasCtx.stroke();
      
      // Update output indicators based on amplitude
      const rms = Math.sqrt(dataArray.reduce((sum, v) => sum + v * v, 0) / bufferLength);
      document.querySelectorAll('.output-indicator').forEach(ind => {
        const idx = parseInt(ind.dataset.ind);
        ind.classList.toggle('active', idx === currentOutput && rms > 0.01);
      });
    }
    
    // Expose functions to window
    window.setParam = (name, value) => {
      if (!jf) return;
      jf.params[name].value = value;
      document.getElementById(name).value = value;
      document.getElementById(name + 'Val').textContent = value.toFixed(3);
    };
    
    window.presetSine = () => {
      setParam('curve', 1);
      setParam('ramp', 0.5);
    };
    
    window.presetTriangle = () => {
      setParam('curve', 0.5);
      setParam('ramp', 0.5);
    };
    
    window.presetSaw = () => {
      setParam('curve', 0.5);
      setParam('ramp', 0);
    };
    
    window.presetSquare = () => {
      setParam('curve', 0);
      setParam('ramp', 0.5);
    };
    
    window.presetFMBass = () => {
      if (!jf) return;
      
      // Enable FLOOM
      currentMode = 2;
      currentRange = 1;
      runEnabled = true;
      
      document.querySelectorAll('#modeGrid .mode-btn').forEach(b => 
        b.classList.toggle('active', parseInt(b.dataset.mode) === currentMode));
      document.querySelectorAll('#rangeToggle .range-btn').forEach(b =>
        b.classList.toggle('active', parseInt(b.dataset.range) === currentRange));
      document.getElementById('runToggle').classList.add('active');
      
      applyAllParams();
      updateModeDisplay();
      
      setParam('time', 0.3);
      setParam('intone', 0.5);
      setParam('curve', 1);
      setParam('ramp', 0.5);
      setParam('fmIndex', 0.5);
      setParam('run', 0);
      
      selectOutput(6);
    };
    
    window.presetChord = () => {
      if (!jf) return;
      
      currentMode = 2;
      currentRange = 1;
      runEnabled = false;
      
      document.querySelectorAll('#modeGrid .mode-btn').forEach(b => 
        b.classList.toggle('active', parseInt(b.dataset.mode) === currentMode));
      document.querySelectorAll('#rangeToggle .range-btn').forEach(b =>
        b.classList.toggle('active', parseInt(b.dataset.range) === currentRange));
      document.getElementById('runToggle').classList.remove('active');
      
      applyAllParams();
      updateModeDisplay();
      
      setParam('time', 0.5);
      setParam('intone', 1);
      setParam('curve', 1);
      setParam('ramp', 0.5);
      setParam('fmIndex', 0);
      
      selectOutput(6);
    };
    
    window.presetNoise = () => {
      if (!jf) return;
      
      // FLOOM noise generation
      currentMode = 2;
      currentRange = 1;
      runEnabled = true;
      
      document.querySelectorAll('#modeGrid .mode-btn').forEach(b => 
        b.classList.toggle('active', parseInt(b.dataset.mode) === currentMode));
      document.querySelectorAll('#rangeToggle .range-btn').forEach(b =>
        b.classList.toggle('active', parseInt(b.dataset.range) === currentRange));
      document.getElementById('runToggle').classList.add('active');
      
      applyAllParams();
      updateModeDisplay();
      
      setParam('time', 0.6);
      setParam('intone', 0.7);
      setParam('curve', 0.5);
      setParam('ramp', 0);
      setParam('fmIndex', 1);
      setParam('run', -0.5);
      
      selectOutput(6);
    };
    
    window.presetPlucks = () => {
      if (!jf) return;
      
      // PLUME mode
      currentMode = 1;
      currentRange = 1;
      runEnabled = true;
      
      document.querySelectorAll('#modeGrid .mode-btn').forEach(b => 
        b.classList.toggle('active', parseInt(b.dataset.mode) === currentMode));
      document.querySelectorAll('#rangeToggle .range-btn').forEach(b =>
        b.classList.toggle('active', parseInt(b.dataset.range) === currentRange));
      document.getElementById('runToggle').classList.add('active');
      
      applyAllParams();
      updateModeDisplay();
      
      setParam('time', 0.5);
      setParam('intone', 1);
      setParam('curve', 1);
      setParam('ramp', 0.5);
      setParam('fmIndex', 0);
      setParam('run', 0);
      
      selectOutput(6);
      
      document.getElementById('triggerMode').value = 'trigger';
      triggerMode = 'trigger';
      document.querySelectorAll('.trigger-btn').forEach(b => b.classList.remove('gate-mode'));
    };
    
    // Event listeners
    document.getElementById('startBtn').addEventListener('click', startAudio);
    document.getElementById('stopBtn').addEventListener('click', stopAudio);
    
    // Output selection
    document.getElementById('outputSelect').addEventListener('click', (e) => {
      if (e.target.classList.contains('output-btn')) {
        selectOutput(parseInt(e.target.dataset.output));
      }
    });
    
    // Mode selection
    document.getElementById('modeGrid').addEventListener('click', (e) => {
      const btn = e.target.closest('.mode-btn');
      if (btn) {
        currentMode = parseInt(btn.dataset.mode);
        document.querySelectorAll('#modeGrid .mode-btn').forEach(b => 
          b.classList.toggle('active', b === btn));
        if (jf) jf.params.mode.value = currentMode;
        updateModeDisplay();
      }
    });
    
    // Range selection
    document.getElementById('rangeToggle').addEventListener('click', (e) => {
      const btn = e.target.closest('.range-btn');
      if (btn) {
        currentRange = parseInt(btn.dataset.range);
        document.querySelectorAll('#rangeToggle .range-btn').forEach(b =>
          b.classList.toggle('active', b === btn));
        if (jf) jf.params.range.value = currentRange;
        updateModeDisplay();
      }
    });
    
    // RUN toggle
    document.getElementById('runToggle').addEventListener('click', () => {
      runEnabled = !runEnabled;
      document.getElementById('runToggle').classList.toggle('active', runEnabled);
      if (jf) jf.params.runEnabled.value = runEnabled ? 1 : 0;
      updateModeDisplay();
    });
    
    // Trigger mode
    document.getElementById('triggerMode').addEventListener('change', (e) => {
      triggerMode = e.target.value;
      document.querySelectorAll('.trigger-btn').forEach(btn => {
        btn.classList.toggle('gate-mode', triggerMode === 'gate');
        btn.textContent = triggerMode === 'gate' ? 'GATE' : 'TRIG';
      });
    });
    
    // Trigger buttons
    document.querySelectorAll('.trigger-btn').forEach(btn => {
      const index = parseInt(btn.dataset.index);
      
      btn.addEventListener('mousedown', () => {
        if (!jf) return;
        btn.classList.add('active');
        
        if (triggerMode === 'trigger') {
          jf.trigger(index);
        } else {
          jf.holdGate(index, true);
        }
      });
      
      btn.addEventListener('mouseup', () => {
        btn.classList.remove('active');
        if (triggerMode === 'gate' && jf) {
          jf.holdGate(index, false);
        }
      });
      
      btn.addEventListener('mouseleave', () => {
        btn.classList.remove('active');
        if (triggerMode === 'gate' && jf) {
          jf.holdGate(index, false);
        }
      });
    });
    
    // Parameter sliders
    ['time', 'intone', 'ramp', 'curve', 'fmIndex', 'run'].forEach(name => {
      const slider = document.getElementById(name);
      const display = document.getElementById(name + 'Val');
      
      slider.addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        display.textContent = val.toFixed(3);
        if (jf) jf.params[name].value = val;
      });
    });
    
    // Volume
    document.getElementById('volume').addEventListener('input', (e) => {
      const val = parseFloat(e.target.value);
      document.getElementById('volumeVal').textContent = val.toFixed(3);
      if (masterGain) masterGain.gain.value = val;
    });
    
    // Initialize display
    updateModeDisplay();
  </script>
</body>
</html>
