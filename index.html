<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phase 5 - Modular Synthesis</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="mod-matrix-styles.css">
  <link rel="stylesheet" href="transpose-sequencer-styles.css">
  <link rel="stylesheet" href="lfo-styles.css">
  <link rel="stylesheet" href="effects-styles.css">
  <link rel="stylesheet" href="wav-recorder-styles.css">
  <link rel="stylesheet" href="transport-styles.css">
  <link rel="stylesheet" href="mimeophon-styles.css">
  <link rel="stylesheet" href="slider-fix.css">  <!-- Must be LAST -->
  <link rel="stylesheet" href="layout-fix.css">
</head>
<body>

  <!-- Floating Transport Sidebar - Always visible on the left side -->
  <div class="transport-sidebar stopped" id="transportSidebar">
    
    <!-- Title -->
    <div class="transport-title">TRANSPORT</div>
    
    <!-- Status Indicator Light -->
    <div class="transport-indicator" id="transportIndicator"></div>
    
    <!-- Status Text -->
    <div class="transport-status" id="transportStatus">Stopped</div>
    
    <!-- Control Buttons -->
    <div class="transport-buttons">
      
      <!-- Play Button -->
      <button class="transport-btn play" id="transportPlayBtn" title="Start Audio" disabled>
        <span class="btn-icon">‚ñ∂</span>
        <span class="transport-tooltip">Start</span>
      </button>
      
      <!-- Stop Button -->
      <button class="transport-btn stop" id="transportStopBtn" title="Stop Audio" style="display: none;">
        <span class="btn-icon">‚èπ</span>
        <span class="transport-tooltip">Stop</span>
      </button>
      
    </div>
    
    <!-- Volume Control -->
    <div class="transport-volume">
      <span class="transport-volume-label">Vol</span>
      <div class="transport-volume-slider-container">
        <input type="range" 
               class="transport-volume-slider-horizontal" 
               id="transportVolume"
               min="0" 
               max="1" 
               step="0.01" 
               value="0.3">
      </div>
      <span class="transport-volume-value" id="transportVolumeValue">0.30</span>
    </div>
    
    <!-- Patch Save/Load -->
    <div class="transport-patch-controls">
      <span class="transport-patch-label">Patch</span>
      
      <button class="transport-btn patch-save" id="transportSaveBtn" title="Save Patch">
        <span class="btn-icon">üíæ</span>
        <span class="transport-tooltip">Save</span>
      </button>
      
      <button class="transport-btn patch-load" id="transportLoadBtn" title="Load Patch">
        <span class="btn-icon">üìÇ</span>
        <span class="transport-tooltip">Load</span>
      </button>
      
      <input type="file" id="patchFileInput" accept=".json,.phase5" style="display: none;">
    </div>
    
  </div>

  <!-- WAV Recorder Sidebar - Always visible on the right side -->
<div class="wav-recorder-sidebar idle" id="wavRecorderSidebar">
  
  <!-- Title -->
  <div class="recorder-title">REC</div>
  
  <!-- Recording Indicator Light -->
  <div class="recorder-indicator" id="recorderIndicator"></div>
  
  <!-- Time Display -->
  <div class="recorder-time" id="recorderTime">00:00.00</div>
  
  <!-- Status Text -->
  <div class="recorder-status" id="recorderStatus">Ready</div>
  
  <!-- Control Buttons -->
  <div class="recorder-buttons">
    
    <!-- Record Button (shown when idle) -->
    <button class="recorder-btn record" id="recorderRecordBtn" title="Start Recording">
      <span class="btn-icon">‚óè</span>
      <span class="recorder-tooltip">Record</span>
    </button>
    
    <!-- Pause Button (shown when recording) -->
    <button class="recorder-btn pause" id="recorderPauseBtn" title="Pause Recording">
      <span class="btn-icon">‚è∏</span>
      <span class="recorder-tooltip">Pause</span>
    </button>
    
    <!-- Stop Button (shown when recording or paused) -->
    <button class="recorder-btn stop" id="recorderStopBtn" title="Stop & Save">
      <span class="btn-icon">‚èπ</span>
      <span class="recorder-tooltip">Stop</span>
    </button>
    
    <!-- Download Button (shown after recording) -->
    <button class="recorder-btn download" id="recorderDownloadBtn" title="Download WAV">
      <span class="btn-icon">‚¨á</span>
      <span class="recorder-tooltip">Download</span>
    </button>
    
    <!-- Cancel Button (shown when recording or paused) -->
    <button class="recorder-btn cancel" id="recorderCancelBtn" title="Cancel Recording">
      <span class="btn-icon">‚úï</span>
    </button>
    
  </div>
  
</div>
  <div class="header">
    <div class="logo">
      <div class="logo-main">PHASE 5</div>
      <div class="logo-sub">modular synthesis system</div>
    </div>
  </div>
  <div class="status-display" id="status">Initializing...</div>

  <div class="main-container">

    <!-- QUANTIZER PANEL -->
    <div class="panel-section">
      <h2 class="section-title">quantizer</h2>
      
      <div class="scale-controls">
        <div class="root-selector">
          <label>root</label>
          <select id="rootNote">
            <option value="0">C</option>
            <option value="1">C#</option>
            <option value="2">D</option>
            <option value="3">D#</option>
            <option value="4">E</option>
            <option value="5">F</option>
            <option value="6">F#</option>
            <option value="7">G</option>
            <option value="8">G#</option>
            <option value="9">A</option>
            <option value="10">A#</option>
            <option value="11">B</option>
          </select>
        </div>
        
        <div class="scale-presets">
          <button class="scale-btn" data-scale="chromatic">chromatic</button>
          <button class="scale-btn active" data-scale="major">major</button>
          <button class="scale-btn" data-scale="minor">minor</button>
          <button class="scale-btn" data-scale="dorian">dorian</button>
          <button class="scale-btn" data-scale="phrygian">phrygian</button>
          <button class="scale-btn" data-scale="lydian">lydian</button>
          <button class="scale-btn" data-scale="mixolydian">mixolydian</button>
          <button class="scale-btn" data-scale="harmonic-minor">harm. min</button>
          <button class="scale-btn" data-scale="penta-maj">penta maj</button>
          <button class="scale-btn" data-scale="penta-min">penta min</button>
          <button class="scale-btn" data-scale="blues">blues</button>
          <button class="scale-btn" data-scale="whole-tone">whole tone</button>
        </div>
      </div>
      
      <div class="param-row">
        <label>depth</label>
        <input type="range" id="quantDepth" min="0" max="8" step="0.01" value="1">
        <span class="param-value" id="quantDepthValue">1.00</span>
      </div>
      
      <div class="param-row">
        <label>offset</label>
        <input type="range" id="quantOffset" min="-4" max="4" step="0.01" value="0">
        <span class="param-value" id="quantOffsetValue">0.00</span>
      </div>
    </div>

    <!-- PIANO KEYBOARD -->
    <div class="panel-section keyboard-panel">
      <h2 class="section-title">keyboard (click to toggle notes)</h2>
      <div class="piano-keyboard" id="pianoKeyboard"></div>
    </div>
    
    <!-- TRANSPOSE SEQUENCER PANEL -->
    <div class="panel-section transpose-sequencer-panel">
      <div class="sequencer-header">
        <h2 class="section-title">transpose sequencer</h2>
        <div class="playback-controls">
          <button class="playback-mode-btn active" data-mode="forward">‚Üí</button>
          <button class="playback-mode-btn" data-mode="backward">‚Üê</button>
          <button class="playback-mode-btn" data-mode="pingpong">‚áÑ</button>
          <button class="playback-mode-btn" data-mode="random">‚ú≥</button>
        </div>
      </div>

    <div class="clock-source-section">
      <div class="control-group-title">clock source</div>
        <div class="clock-source-control">
          <select id="transposeClockSource" class="control-select clock-select">
            <option value="jf">Just Friends (zero crossings)</option>
          </select>
        <div class="clock-indicator jf" id="clockSourceIndicator">
          Clocked by Just Friends
        </div>
        <p class="clock-description">
          <strong>Just Friends:</strong> Advances on each JF #1 slope cycle
        </p>
      </div>
    </div>
      
      <div id="sequencerGrid"></div>
      
      <div class="sequencer-actions">
        <button class="seq-action-btn" id="seqResetBtn">reset to step 1</button>
        <button class="seq-action-btn" id="seqClearBtn">clear all steps</button>
        <button class="seq-action-btn" id="seqRandomizeBtn">randomize</button>
      </div>
    </div>

    <!-- JF #1 PANEL -->
    <div class="panel-section">
      <h2 class="section-title">just friends #1 (clock source)</h2>
      
      <div class="param-row">
        <label>time</label>
        <input type="range" id="jf1Time" min="0" max="1" step="0.01" value="0.25">
        <span class="param-value" id="jf1TimeValue">0.25</span>
      </div>
      
      <div class="param-row">
        <label>intone</label>
        <input type="range" id="jf1Intone" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="jf1IntoneValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>ramp</label>
        <input type="range" id="jf1Ramp" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="jf1RampValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>curve</label>
        <input type="range" id="jf1Curve" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="jf1CurveValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>mode</label>
        <select id="jf1Mode">
          <option value="0">transient</option>
          <option value="1">sustain</option>
          <option value="2" selected>cycle</option>
        </select>
      </div>
      
      <div class="param-row">
        <label>range</label>
        <select id="jf1Range">
          <option value="0" selected>shape</option>
          <option value="1">sound</option>
        </select>
      </div>
    </div>

    <!-- SCOPE 1 -->
    <div class="panel-section scope-panel">
      <h2 class="section-title">scope 1 (jf #1 identity)</h2>
      <canvas id="scope1" width="800" height="200"></canvas>
      <p class="scope-info">Clock source for transpose sequencer</p>
    </div>

    <!-- OSCILLATOR SELECTION PANEL -->
    <div class="panel-section oscillator-select-panel">
      <h2 class="section-title">oscillator selection</h2>
      
      <div class="osc-toggle-group">
        <button class="osc-toggle-btn active" data-osc="mangrove">
          <span class="osc-name">Mangrove A</span>
          <span class="osc-desc">Formant oscillator with FM</span>
        </button>
        <button class="osc-toggle-btn" data-osc="justfriends">
          <span class="osc-name">Just Friends Osc</span>
          <span class="osc-desc">6-slope waveshaper with RUN modes</span>
        </button>
      </div>

      <!-- FM ROUTING SECTION -->
      <div class="fm-toggle-section">
        <h3 class="section-title">fm routing (mangrove b)</h3>
        
        <div class="param-row fm-toggle-row">
          <label class="toggle-label">
            <input type="checkbox" id="fmEnable">
            <span class="toggle-text">Enable FM B ‚Üí Active Oscillator</span>
          </label>
        </div>

        <div class="fm-mode-group">
          <button class="fm-mode-btn active" data-mode="exponential">
            <span class="fm-mode-name">Exponential FM</span>
            <span class="fm-mode-desc">Pitch modulation (1V/oct)</span>
          </button>
          <button class="fm-mode-btn" data-mode="linear">
            <span class="fm-mode-name">Linear FM</span>
            <span class="fm-mode-desc">Through-zero FM</span>
          </button>
        </div>
      </div>
    </div>

    <!-- MANGROVE A PANEL -->
    <div class="panel-section" id="mangrovePanel">
      <h2 class="section-title">mangrove a (main voice)</h2>
      
      <div class="param-row">
        <label>pitch</label>
        <input type="range" id="maPitch" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="maPitchValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>barrel</label>
        <input type="range" id="maBarrel" min="0" max="1" step="0.01" value="0.3">
        <span class="param-value" id="maBarrelValue">0.30</span>
      </div>
      
      <div class="param-row">
        <label>formant</label>
        <input type="range" id="maFormant" min="0" max="1" step="0.01" value="0.6">
        <span class="param-value" id="maFormantValue">0.60</span>
      </div>
      
      <div class="param-row">
        <label>air</label>
        <input type="range" id="maAir" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="maAirValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>fm depth</label>
        <input type="range" id="maFmIndex" min="0" max="1" step="0.01" value="0.3">
        <span class="param-value" id="maFmIndexValue">0.30</span>
      </div>
    </div>

    <!-- JUST FRIENDS OSC PANEL (hidden by default) -->
    <div class="panel-section" id="jfOscPanel" style="display: none;">
      <h2 class="section-title">
        just friends osc
        <span class="mode-badge" id="jfOscModeBadge">cycle/sound</span>
      </h2>
      
      <div class="jfosc-mode-controls">
        <select id="jfOscMode">
          <option value="0">transient</option>
          <option value="1">sustain</option>
          <option value="2" selected>cycle</option>
        </select>
        
        <select id="jfOscRange">
          <option value="0">shape</option>
          <option value="1" selected>sound</option>
        </select>
        
        <label class="toggle-label">
          <input type="checkbox" id="jfOscRunToggle">
          <span class="toggle-text">RUN</span>
        </label>
      </div>
      
      <div class="param-row">
        <label>time</label>
        <input type="range" id="jfOscTime" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="jfOscTimeValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>intone</label>
        <input type="range" id="jfOscIntone" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="jfOscIntoneValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>ramp</label>
        <input type="range" id="jfOscRamp" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="jfOscRampValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>curve</label>
        <input type="range" id="jfOscCurve" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="jfOscCurveValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>fm index</label>
        <input type="range" id="jfOscFmIndex" min="-1" max="1" step="0.01" value="0">
        <span class="param-value" id="jfOscFmIndexValue">0.00</span>
      </div>
      
      <div class="param-row">
        <label>run</label>
        <input type="range" id="jfOscRun" min="-1" max="1" step="0.01" value="0">
        <span class="param-value" id="jfOscRunValue">0.00</span>
      </div>

      <div class="jfosc-triggers">
        <h3 class="section-title">triggers</h3>
        <div class="trigger-group">
          <button class="jfosc-trigger-btn" data-index="0">1N</button>
          <button class="jfosc-trigger-btn" data-index="1">2N</button>
          <button class="jfosc-trigger-btn" data-index="2">3N</button>
          <button class="jfosc-trigger-btn" data-index="3">4N</button>
          <button class="jfosc-trigger-btn" data-index="4">5N</button>
          <button class="jfosc-trigger-btn" data-index="5">6N</button>
        </div>
      </div>
    </div>

    <!-- MANGROVE B PANEL -->
    <div class="panel-section">
      <h2 class="section-title">mangrove b (fm modulator)</h2>
      
      <div class="param-row">
        <label>pitch</label>
        <input type="range" id="mbPitch" min="0" max="1" step="0.01" value="0.52">
        <span class="param-value" id="mbPitchValue">0.52</span>
      </div>
      
      <div class="param-row">
        <label>barrel</label>
        <input type="range" id="mbBarrel" min="0" max="1" step="0.01" value="0.65">
        <span class="param-value" id="mbBarrelValue">0.65</span>
      </div>
      
      <div class="param-row">
        <label>formant</label>
        <input type="range" id="mbFormant" min="0" max="1" step="0.01" value="0.55">
        <span class="param-value" id="mbFormantValue">0.55</span>
      </div>
    </div>

    <!-- MANGROVE C PANEL -->
    <div class="panel-section">
      <h2 class="section-title">mangrove c (filter fm)</h2>
      
      <div class="param-row">
        <label>pitch</label>
        <input type="range" id="mcPitch" min="0" max="1" step="0.01" value="0.6">
        <span class="param-value" id="mcPitchValue">0.60</span>
      </div>
      
      <div class="param-row">
        <label>barrel</label>
        <input type="range" id="mcBarrel" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="mcBarrelValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>formant</label>
        <input type="range" id="mcFormant" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="mcFormantValue">0.50</span>
      </div>
    </div>

    <!-- THREE SISTERS PANEL -->
    <div class="panel-section">
      <h2 class="section-title">three sisters</h2>
      
      <div class="param-row">
        <label>freq</label>
        <input type="range" id="tsFreq" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="tsFreqValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>span</label>
        <input type="range" id="tsSpan" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="tsSpanValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>quality</label>
        <input type="range" id="tsQuality" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="tsQualityValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>fm atten</label>
        <input type="range" id="tsFmAtten" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="tsFmAttenValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>mode</label>
        <select id="tsMode">
          <option value="0">crossover</option>
          <option value="1">formant</option>
        </select>
      </div>
    </div>

    <!-- SCOPE 2 - MOVED HERE (after Three Sisters, before modulation matrix) -->
    <div class="panel-section scope-panel">
      <h2 class="section-title">scope 2 (three sisters output)</h2>
      <canvas id="scope2" width="800" height="200"></canvas>
      <p class="scope-info">Final audio output</p>
    </div>

    <!-- MODULATION MATRIX PANEL -->
    <div class="panel-section mod-matrix-panel">
      <h2 class="section-title">modulation matrix (jf #1 slopes)</h2>
      
      <div class="mod-matrix-hint">
        <p><strong>Route JF #1 slopes (2N-6N) to any parameter.</strong></p>
        <p>Each slope can modulate a different destination with independent depth, offset, and polarity control.</p>
      </div>
      
      <div class="mod-slots-container" id="modSlotsContainer">
        <!-- Modulation slots generated by JavaScript -->
      </div>
    </div>

    <!-- 7 LFO MODULATION PANEL -->
    <div class="panel-section lfo-panel">
      <h2 class="section-title">lfo modulation (7 independent lfos)</h2>
      
      <div class="mod-matrix-hint">
        <p><strong>7 independent LFOs with dual destinations.</strong></p>
        <p>Each LFO can modulate two different parameters simultaneously with independent depth, offset, and polarity control.</p>
        <p>LFOs can modulate nearly every parameter in the system, including other LFOs for complex modulation.</p>
      </div>
      
      <div class="lfo-grid" id="lfoGridContainer">
        <!-- 7 LFO modules generated by JavaScript -->
      </div>
    </div>

    <!-- EFFECTS CHAIN PANEL -->
    <div class="panel-section effects-chain-panel">
      <h2 class="section-title">effects chain (synth only)</h2>
      <div id="effectsContainer" class="effects-container">
        <!-- Effects will be generated by JavaScript -->
      </div>
    </div>

    <!-- MASTER CONTROLS -->
    <div class="panel-section">
      <h2 class="section-title">master</h2>
      
      <div class="param-row">
        <label>volume</label>
        <input type="range" id="masterVolume" min="0" max="1" step="0.01" value="0.3">
        <span class="param-value" id="masterVolumeValue">0.30</span>
      </div>
      
      <button class="action-btn" id="startBtn" disabled>
        <span class="btn-icon">‚ñ∂</span> Start Audio
      </button>
    </div>
  </div>

  <div class="footer">
    <div class="footer-hint">
      Phase 5 - Modular synthesis system with transpose sequencing
    </div>
  </div>

  <script type="module" src="./main.js"></script>
  <script src="./transport-init.js"></script>
</body>
</html>
