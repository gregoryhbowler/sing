<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phase 5 - René Upgraded</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="mod-matrix-styles.css">
  <link rel="stylesheet" href="transpose-sequencer-styles.css">
  <link rel="stylesheet" href="rene-styles-redesigned.css">
  <link rel="stylesheet" href="rene-pattern-ui-styles.css">
  <link rel="stylesheet" href="lfo-styles.css">
  <link rel="stylesheet" href="drum-machine-styles.css">
  <link rel="stylesheet" href="effects-styles.css">
  <link rel="stylesheet" href="wav-recorder-styles.css">
  <link rel="stylesheet" href="transport-styles.css">
</head>
<body>

  <!-- Floating Transport Sidebar - Always visible on the left side -->
  <div class="transport-sidebar stopped" id="transportSidebar">
    
    <!-- Title -->
    <div class="transport-title">TRANSPORT</div>
    
    <!-- Status Indicator Light -->
    <div class="transport-indicator" id="transportIndicator"></div>
    
    <!-- Status Text -->
    <div class="transport-status" id="transportStatus">Stopped</div>
    
    <!-- Control Buttons -->
    <div class="transport-buttons">
      
      <!-- Play Button -->
      <button class="transport-btn play" id="transportPlayBtn" title="Start Audio" disabled>
        <span class="btn-icon">▶</span>
        <span class="transport-tooltip">Start</span>
      </button>
      
      <!-- Stop Button -->
      <button class="transport-btn stop" id="transportStopBtn" title="Stop Audio" style="display: none;">
        <span class="btn-icon">⏹</span>
        <span class="transport-tooltip">Stop</span>
      </button>
      
    </div>
    
    <!-- Volume Control -->
    <div class="transport-volume">
      <span class="transport-volume-label">Vol</span>
      <div class="transport-volume-slider-container">
        <input type="range" 
               class="transport-volume-slider-horizontal" 
               id="transportVolume"
               min="0" 
               max="1" 
               step="0.01" 
               value="0.3">
      </div>
      <span class="transport-volume-value" id="transportVolumeValue">0.30</span>
    </div>
    
  </div>

  <!-- WAV Recorder Sidebar - Always visible on the right side -->
<div class="wav-recorder-sidebar idle" id="wavRecorderSidebar">
  
  <!-- Title -->
  <div class="recorder-title">REC</div>
  
  <!-- Recording Indicator Light -->
  <div class="recorder-indicator" id="recorderIndicator"></div>
  
  <!-- Time Display -->
  <div class="recorder-time" id="recorderTime">00:00.00</div>
  
  <!-- Status Text -->
  <div class="recorder-status" id="recorderStatus">Ready</div>
  
  <!-- Control Buttons -->
  <div class="recorder-buttons">
    
    <!-- Record Button (shown when idle) -->
    <button class="recorder-btn record" id="recorderRecordBtn" title="Start Recording">
      <span class="btn-icon">●</span>
      <span class="recorder-tooltip">Record</span>
    </button>
    
    <!-- Pause Button (shown when recording) -->
    <button class="recorder-btn pause" id="recorderPauseBtn" title="Pause Recording">
      <span class="btn-icon">⏸</span>
      <span class="recorder-tooltip">Pause</span>
    </button>
    
    <!-- Stop Button (shown when recording or paused) -->
    <button class="recorder-btn stop" id="recorderStopBtn" title="Stop & Save">
      <span class="btn-icon">⏹</span>
      <span class="recorder-tooltip">Stop</span>
    </button>
    
    <!-- Download Button (shown after recording) -->
    <button class="recorder-btn download" id="recorderDownloadBtn" title="Download WAV">
      <span class="btn-icon">⬇</span>
      <span class="recorder-tooltip">Download</span>
    </button>
    
    <!-- Cancel Button (shown when recording or paused) -->
    <button class="recorder-btn cancel" id="recorderCancelBtn" title="Cancel Recording">
      <span class="btn-icon">✕</span>
    </button>
    
  </div>
  
</div>
  <div class="header">
    <div class="logo">
      <div class="logo-main">PHASE 5</div>
      <div class="logo-sub">modular synthesis system</div>
    </div>
    <div class="mode-selector">
      <button class="header-mode-btn active" id="normalModeBtn">Normal</button>
      <button class="header-mode-btn" id="reneModeBtn">René</button>
    </div>
  </div>
  <div class="status-display" id="status">Initializing...</div>

  <div class="main-container">

    <!-- René Pattern System - Complete HTML Structure -->
<div class="rene-pattern-system" id="renePatternSystem" style="display: none;">
  
  <!-- Header with all controls -->
  <div class="pattern-system-header">
    <!-- Title -->
    <h3 class="pattern-system-title">rené pattern system (8 patterns)</h3>
    
    <!-- Mode Indicator (shows current state) -->
    <div class="mode-indicator edit-mode" id="reneModeIndicator">
      ✎ edit mode
    </div>
    
    <!-- Mode Toggle Buttons (Edit/Pattern/Blank) -->
    <div class="pattern-mode-toggle">
      <button class="pattern-playback-btn active" id="patternEditModeBtn">
        ✎ Edit Mode
      </button>
      <button class="pattern-playback-btn" id="patternPlaybackModeBtn">
        ⏵ Pattern Mode
      </button>
      <button class="pattern-blank-btn" id="patternBlankBtn">
        ⚪ Blank
      </button>
    </div>
    
    <!-- Playback Control -->
    <div class="pattern-playback-toggle">
      <button class="pattern-playback-btn" id="patternPlaybackBtn">
        ▶ Enable Playback
      </button>
    </div>
  </div>
  
  <!-- Playback Mode Selection -->
  <div class="pattern-mode-controls">
    <button class="pattern-mode-btn active" data-mode="linear">
      Linear (with repeats)
    </button>
    <button class="pattern-mode-btn" data-mode="manual">
      Manual Trigger
    </button>
  </div>
  
  <!-- Pattern Grid (8 slots) -->
  <div class="pattern-grid" id="patternGrid">
    <!-- Slots will be generated by JavaScript -->
    <!-- Example slot structure:
    <div class="pattern-slot empty selected" data-index="0">
      <div class="pattern-slot-header">
        <span class="pattern-number">1</span>
        <div class="pattern-status"></div>
      </div>
      <div class="pattern-name">Empty</div>
      <div class="pattern-repeats">
        <span class="pattern-repeats-label">×</span>
        <input type="number" class="pattern-repeats-input" 
               data-index="0" min="1" max="99" value="1">
      </div>
    </div>
    -->
  </div>
  
  <!-- Pattern Control Buttons -->
  <div class="pattern-controls">
    <button class="pattern-control-btn" id="patternSetBtn">
      Set Current
    </button>
    <button class="pattern-control-btn" id="patternCopyBtn">
      Copy
    </button>
    <button class="pattern-control-btn" id="patternPasteBtn">
      Paste
    </button>
    <button class="pattern-control-btn danger" id="patternClearAllBtn">
      Clear All
    </button>
  </div>
  
</div>

<!-- CSS Requirements -->
<style>
  /* Make sure pattern system spans full width like René panel */
  .rene-pattern-system {
    grid-column: 1 / -1; /* Span all columns in parent grid */
  }
</style>

    <!-- RENÉ SEQUENCER PANEL (UPGRADED: 4 Mod Lanes) -->
    <div class="panel-section rene-mode-panel" id="reneModePanel" style="display: none;">
  
      <!-- Header with Title, Tabs, and Transport -->
      <div class="rene-header">
        <h2 class="section-title">rené sequencer</h2>
        
        <!-- Centered Tabs (UPGRADED: 4 mod lanes) -->
        <div class="rene-tabs">
          <button class="rene-tab active" data-lane="note">notes</button>
          <button class="rene-tab" data-lane="gate">gates</button>
          <button class="rene-tab" data-lane="mod0">mod 1</button>
          <button class="rene-tab" data-lane="mod1">mod 2</button>
          <button class="rene-tab" data-lane="mod2">mod 3</button>
          <button class="rene-tab" data-lane="mod3">mod 4</button>
        </div>
        
        <!-- Mini Transport Controls -->
        <div class="transport-controls-header">
          <button class="transport-btn-mini" id="renePlayBtnMini" title="Play">▶</button>
          <button class="transport-btn-mini" id="reneStopBtnMini" title="Stop">⏸</button>
          <button class="transport-btn-mini" id="reneResetBtnMini" title="Reset">↻</button>
        </div>
      </div>
      
      <!-- Main Content: Grid + Control Panel -->
      <div class="rene-main-content">
        
        <!-- Left: Note/Gate/Mod Grids -->
        <div class="rene-grids-container">
          
          <!-- Note Lane (4x4 Grid of Knobs) -->
          <div class="rene-lane" id="reneLaneNote">
            <div class="rene-grid" id="noteGrid">
              <!-- 16 rotary knobs generated by JavaScript -->
            </div>
          </div>
          
          <!-- Gate Lane (4x4 Grid of Square Buttons) -->
          <div class="rene-lane" id="reneLaneGate" style="display: none;">
            <div class="rene-grid" id="gateGrid">
              <!-- 16 square toggle buttons generated by JavaScript -->
            </div>
          </div>
          
          <!-- UPGRADED: 4 Mod Lanes -->
          <div class="rene-lane" id="reneLaneMod0" style="display: none;">
            <div class="rene-grid" id="modGrid0">
              <!-- 16 rotary knobs generated by JavaScript -->
            </div>
            
            <!-- Mod Target Controls -->
            <div class="control-group mod-target-section" style="margin-top: var(--space-lg);">
              <div class="control-group-title">mod 1 target</div>
              
              <select id="modTarget0" class="control-select">
                <!-- Options populated by JavaScript -->
              </select>
              
              <div class="control-slider-group">
                <div class="control-slider-label">
                  <span>depth</span>
                  <span class="control-value" id="modDepthValue0">0.50</span>
                </div>
                <input type="range" 
                       id="modDepth0" 
                       class="control-slider"
                       min="0" 
                       max="1" 
                       step="0.01" 
                       value="0.5">
              </div>
            </div>
          </div>
          
          <div class="rene-lane" id="reneLaneMod1" style="display: none;">
            <div class="rene-grid" id="modGrid1"></div>
            <div class="control-group mod-target-section" style="margin-top: var(--space-lg);">
              <div class="control-group-title">mod 2 target</div>
              <select id="modTarget1" class="control-select"></select>
              <div class="control-slider-group">
                <div class="control-slider-label">
                  <span>depth</span>
                  <span class="control-value" id="modDepthValue1">0.50</span>
                </div>
                <input type="range" id="modDepth1" class="control-slider"
                       min="0" max="1" step="0.01" value="0.5">
              </div>
            </div>
          </div>
          
          <div class="rene-lane" id="reneLaneMod2" style="display: none;">
            <div class="rene-grid" id="modGrid2"></div>
            <div class="control-group mod-target-section" style="margin-top: var(--space-lg);">
              <div class="control-group-title">mod 3 target</div>
              <select id="modTarget2" class="control-select"></select>
              <div class="control-slider-group">
                <div class="control-slider-label">
                  <span>depth</span>
                  <span class="control-value" id="modDepthValue2">0.50</span>
                </div>
                <input type="range" id="modDepth2" class="control-slider"
                       min="0" max="1" step="0.01" value="0.5">
              </div>
            </div>
          </div>
          
          <div class="rene-lane" id="reneLaneMod3" style="display: none;">
            <div class="rene-grid" id="modGrid3"></div>
            <div class="control-group mod-target-section" style="margin-top: var(--space-lg);">
              <div class="control-group-title">mod 4 target</div>
              <select id="modTarget3" class="control-select"></select>
              <div class="control-slider-group">
                <div class="control-slider-label">
                  <span>depth</span>
                  <span class="control-value" id="modDepthValue3">0.50</span>
                </div>
                <input type="range" id="modDepth3" class="control-slider"
                       min="0" max="1" step="0.01" value="0.5">
              </div>
            </div>
          </div>
          
        </div>
        
        <!-- Right: Control Panel -->
        <div class="rene-control-panel">
          
          <!-- Tempo Control -->
          <div class="control-group">
            <div class="control-group-title">tempo</div>
            <div class="control-slider-group">
              <div class="control-slider-label">
                <span>bpm</span>
                <span class="control-value" id="reneTempoValue">120</span>
              </div>
              <input type="range" 
                     id="reneTempo" 
                     class="control-slider"
                     min="10" 
                     max="300" 
                     step="1" 
                     value="120">
            </div>
          </div>
          
          <!-- Note Lane Controls -->
          <div class="control-group">
            <div class="control-group-title">note lane</div>
            
            <div class="control-slider-group">
              <div class="control-slider-label">
                <span>length</span>
                <span class="control-value" id="noteLaneLengthValue">16</span>
              </div>
              <input type="range" 
                     id="noteLaneLength" 
                     class="control-slider"
                     min="1" 
                     max="16" 
                     step="1" 
                     value="16">
            </div>
            
            <div class="control-slider-group">
              <div class="control-slider-label">
                <span>division</span>
              </div>
              <select id="noteLaneDiv" class="control-select">
                <option value="1/16">1/16</option>
                <option value="1/8">1/8</option>
                <option value="1/4" selected>1/4</option>
                <option value="1/2">1/2</option>
                <option value="1/1">1/1</option>
                <option value="2/1">2/1</option>
                <option value="2/2">2/2</option>
              </select>
            </div>
          </div>
          
          <!-- Gate Lane Controls -->
          <div class="control-group">
            <div class="control-group-title">gate lane</div>
            
            <div class="control-slider-group">
              <div class="control-slider-label">
                <span>length</span>
                <span class="control-value" id="gateLaneLengthValue">16</span>
              </div>
              <input type="range" 
                     id="gateLaneLength" 
                     class="control-slider"
                     min="1" 
                     max="16" 
                     step="1" 
                     value="16">
            </div>
            
            <div class="control-slider-group">
              <div class="control-slider-label">
                <span>division</span>
              </div>
              <select id="gateLaneDiv" class="control-select">
                <option value="1/16">1/16</option>
                <option value="1/8">1/8</option>
                <option value="1/4" selected>1/4</option>
                <option value="1/2">1/2</option>
                <option value="1/1">1/1</option>
                <option value="2/1">2/1</option>
                <option value="2/2">2/2</option>
              </select>
            </div>
          </div>
          
          <!-- UPGRADED: 4 Mod Lane Controls -->
          <div class="control-group" id="modLaneControls0">
            <div class="control-group-title">mod 1 lane</div>
            <div class="control-slider-group">
              <div class="control-slider-label">
                <span>length</span>
                <span class="control-value" id="mod0LaneLengthValue">16</span>
              </div>
              <input type="range" id="mod0LaneLength" class="control-slider"
                     min="1" max="16" step="1" value="16">
            </div>
            <div class="control-slider-group">
              <div class="control-slider-label"><span>division</span></div>
              <select id="mod0LaneDiv" class="control-select">
                <option value="1/16">1/16</option>
                <option value="1/8">1/8</option>
                <option value="1/4" selected>1/4</option>
                <option value="1/2">1/2</option>
                <option value="1/1">1/1</option>
                <option value="2/1">2/1</option>
                <option value="2/2">2/2</option>
              </select>
            </div>
          </div>
          
          <div class="control-group" id="modLaneControls1">
            <div class="control-group-title">mod 2 lane</div>
            <div class="control-slider-group">
              <div class="control-slider-label">
                <span>length</span>
                <span class="control-value" id="mod1LaneLengthValue">16</span>
              </div>
              <input type="range" id="mod1LaneLength" class="control-slider"
                     min="1" max="16" step="1" value="16">
            </div>
            <div class="control-slider-group">
              <div class="control-slider-label"><span>division</span></div>
              <select id="mod1LaneDiv" class="control-select">
                <option value="1/16">1/16</option>
                <option value="1/8">1/8</option>
                <option value="1/4" selected>1/4</option>
                <option value="1/2">1/2</option>
                <option value="1/1">1/1</option>
                <option value="2/1">2/1</option>
                <option value="2/2">2/2</option>
              </select>
            </div>
          </div>
          
          <div class="control-group" id="modLaneControls2">
            <div class="control-group-title">mod 3 lane</div>
            <div class="control-slider-group">
              <div class="control-slider-label">
                <span>length</span>
                <span class="control-value" id="mod2LaneLengthValue">16</span>
              </div>
              <input type="range" id="mod2LaneLength" class="control-slider"
                     min="1" max="16" step="1" value="16">
            </div>
            <div class="control-slider-group">
              <div class="control-slider-label"><span>division</span></div>
              <select id="mod2LaneDiv" class="control-select">
                <option value="1/16">1/16</option>
                <option value="1/8">1/8</option>
                <option value="1/4" selected>1/4</option>
                <option value="1/2">1/2</option>
                <option value="1/1">1/1</option>
                <option value="2/1">2/1</option>
                <option value="2/2">2/2</option>
              </select>
            </div>
          </div>
          
          <div class="control-group" id="modLaneControls3">
            <div class="control-group-title">mod 4 lane</div>
            <div class="control-slider-group">
              <div class="control-slider-label">
                <span>length</span>
                <span class="control-value" id="mod3LaneLengthValue">16</span>
              </div>
              <input type="range" id="mod3LaneLength" class="control-slider"
                     min="1" max="16" step="1" value="16">
            </div>
            <div class="control-slider-group">
              <div class="control-slider-label"><span>division</span></div>
              <select id="mod3LaneDiv" class="control-select">
                <option value="1/16">1/16</option>
                <option value="1/8">1/8</option>
                <option value="1/4" selected>1/4</option>
                <option value="1/2">1/2</option>
                <option value="1/1">1/1</option>
                <option value="2/1">2/1</option>
                <option value="2/2">2/2</option>
              </select>
            </div>
          </div>
          
          <!-- Snake Pattern Dropdown -->
          <div class="control-group">
            <div class="control-group-title">snake pattern</div>
            <select id="snakePatternSelect" class="control-select">
              <!-- Options populated by JavaScript -->
            </select>
          </div>
          
          <!-- Playback Mode -->
          <div class="control-group">
            <div class="control-group-title">playback mode</div>
            <div class="mode-toggle-group">
              <button class="mode-toggle-option active" data-mode="forward">→</button>
              <button class="mode-toggle-option" data-mode="reverse">←</button>
              <button class="mode-toggle-option" data-mode="pingpong">⇄</button>
              <button class="mode-toggle-option" data-mode="random">✳</button>
            </div>
          </div>
          
          <!-- Step Enable -->
          <div class="control-group">
            <div class="control-group-title">step enable</div>
            <div class="step-enable-grid">
              <!-- 16 checkboxes generated inline -->
              <label class="step-enable-cell" data-step="0">
                <input type="checkbox" class="step-enable-checkbox" data-step="0" checked>
                <span>1</span>
              </label>
              <label class="step-enable-cell" data-step="1">
                <input type="checkbox" class="step-enable-checkbox" data-step="1" checked>
                <span>2</span>
              </label>
              <label class="step-enable-cell" data-step="2">
                <input type="checkbox" class="step-enable-checkbox" data-step="2" checked>
                <span>3</span>
              </label>
              <label class="step-enable-cell" data-step="3">
                <input type="checkbox" class="step-enable-checkbox" data-step="3" checked>
                <span>4</span>
              </label>
              <label class="step-enable-cell" data-step="4">
                <input type="checkbox" class="step-enable-checkbox" data-step="4" checked>
                <span>5</span>
              </label>
              <label class="step-enable-cell" data-step="5">
                <input type="checkbox" class="step-enable-checkbox" data-step="5" checked>
                <span>6</span>
              </label>
              <label class="step-enable-cell" data-step="6">
                <input type="checkbox" class="step-enable-checkbox" data-step="6" checked>
                <span>7</span>
              </label>
              <label class="step-enable-cell" data-step="7">
                <input type="checkbox" class="step-enable-checkbox" data-step="7" checked>
                <span>8</span>
              </label>
              <label class="step-enable-cell" data-step="8">
                <input type="checkbox" class="step-enable-checkbox" data-step="8" checked>
                <span>9</span>
              </label>
              <label class="step-enable-cell" data-step="9">
                <input type="checkbox" class="step-enable-checkbox" data-step="9" checked>
                <span>10</span>
              </label>
              <label class="step-enable-cell" data-step="10">
                <input type="checkbox" class="step-enable-checkbox" data-step="10" checked>
                <span>11</span>
              </label>
              <label class="step-enable-cell" data-step="11">
                <input type="checkbox" class="step-enable-checkbox" data-step="11" checked>
                <span>12</span>
              </label>
              <label class="step-enable-cell" data-step="12">
                <input type="checkbox" class="step-enable-checkbox" data-step="12" checked>
                <span>13</span>
              </label>
              <label class="step-enable-cell" data-step="13">
                <input type="checkbox" class="step-enable-checkbox" data-step="13" checked>
                <span>14</span>
              </label>
              <label class="step-enable-cell" data-step="14">
                <input type="checkbox" class="step-enable-checkbox" data-step="14" checked>
                <span>15</span>
              </label>
              <label class="step-enable-cell" data-step="15">
                <input type="checkbox" class="step-enable-checkbox" data-step="15" checked>
                <span>16</span>
              </label>
            </div>
          </div>
          
        </div>
        
      </div>
      
    </div>

<!-- Envelope Panel (SINGLE INSTANCE - FIXED) -->
<div class="panel-section envelope-panel" id="envelopePanel" style="display: none;">
  <h2 class="section-title">envelope + vca</h2>
  
  <div class="envelope-mode-controls">
    <div class="mode-toggle-group">
      <button class="env-mode-btn" data-mode="AD">AD</button>
      <button class="env-mode-btn active" data-mode="ASR">ASR</button>
    </div>
    
    <div class="mode-toggle-group">
      <button class="curve-btn" data-curve="linear">Linear</button>
      <button class="curve-btn active" data-curve="exponential">Exponential</button>
    </div>
  </div>
  
  <div class="param-row">
    <label>attack</label>
    <input type="range" id="envAttack" min="0.001" max="3" step="0.001" value="0.03">
    <span class="param-value" id="envAttackValue">0.030</span>
  </div>
  
  <div class="param-row">
    <label>decay/release</label>
    <input type="range" id="envDecay" min="0.005" max="10" step="0.005" value="0.5">
    <span class="param-value" id="envDecayValue">0.500</span>
  </div>
  
  <div class="param-row">
    <label>sustain</label>
    <input type="range" id="envSustain" min="0" max="1" step="0.01" value="0.7">
    <span class="param-value" id="envSustainValue">0.70</span>
  </div>
</div>

    <!-- QUANTIZER PANEL -->
    <div class="panel-section">
      <h2 class="section-title">quantizer</h2>
      
      <div class="scale-controls">
        <div class="root-selector">
          <label>root</label>
          <select id="rootNote">
            <option value="0">C</option>
            <option value="1">C#</option>
            <option value="2">D</option>
            <option value="3">D#</option>
            <option value="4">E</option>
            <option value="5">F</option>
            <option value="6">F#</option>
            <option value="7">G</option>
            <option value="8">G#</option>
            <option value="9">A</option>
            <option value="10">A#</option>
            <option value="11">B</option>
          </select>
        </div>
        
        <div class="scale-presets">
          <button class="scale-btn" data-scale="chromatic">chromatic</button>
          <button class="scale-btn active" data-scale="major">major</button>
          <button class="scale-btn" data-scale="minor">minor</button>
          <button class="scale-btn" data-scale="dorian">dorian</button>
          <button class="scale-btn" data-scale="phrygian">phrygian</button>
          <button class="scale-btn" data-scale="lydian">lydian</button>
          <button class="scale-btn" data-scale="mixolydian">mixolydian</button>
          <button class="scale-btn" data-scale="harmonic-minor">harm. min</button>
          <button class="scale-btn" data-scale="penta-maj">penta maj</button>
          <button class="scale-btn" data-scale="penta-min">penta min</button>
          <button class="scale-btn" data-scale="blues">blues</button>
          <button class="scale-btn" data-scale="whole-tone">whole tone</button>
        </div>
      </div>
      
      <div class="param-row">
        <label>depth</label>
        <input type="range" id="quantDepth" min="0" max="8" step="0.01" value="1">
        <span class="param-value" id="quantDepthValue">1.00</span>
      </div>
      
      <div class="param-row">
        <label>offset</label>
        <input type="range" id="quantOffset" min="-4" max="4" step="0.01" value="0">
        <span class="param-value" id="quantOffsetValue">0.00</span>
      </div>
    </div>

    <!-- PIANO KEYBOARD -->
    <div class="panel-section keyboard-panel">
      <h2 class="section-title">keyboard (click to toggle notes)</h2>
      <div class="piano-keyboard" id="pianoKeyboard"></div>
    </div>
    
    <!-- TRANSPOSE SEQUENCER PANEL -->
    <div class="panel-section transpose-sequencer-panel">
      <div class="sequencer-header">
        <h2 class="section-title">transpose sequencer</h2>
        <div class="playback-controls">
          <button class="playback-mode-btn active" data-mode="forward">→</button>
          <button class="playback-mode-btn" data-mode="backward">←</button>
          <button class="playback-mode-btn" data-mode="pingpong">⇄</button>
          <button class="playback-mode-btn" data-mode="random">✳</button>
        </div>
      </div>

    <div class="clock-source-section">
      <div class="control-group-title">clock source</div>
        <div class="clock-source-control">
          <select id="transposeClockSource" class="control-select clock-select">
            <option value="jf">Just Friends (zero crossings)</option>
            <option value="rene">René (note sequence cycles)</option>
          </select>
        <div class="clock-indicator jf" id="clockSourceIndicator">
          Clocked by Just Friends
        </div>
        <p class="clock-description">
          <strong>Just Friends:</strong> Advances on each JF #1 slope cycle<br>
          <strong>René:</strong> Advances when René completes a full note sequence
        </p>
      </div>
    </div>
      
      <div id="sequencerGrid"></div>
      
      <div class="sequencer-actions">
        <button class="seq-action-btn" id="seqResetBtn">reset to step 1</button>
        <button class="seq-action-btn" id="seqClearBtn">clear all steps</button>
        <button class="seq-action-btn" id="seqRandomizeBtn">randomize</button>
      </div>
    </div>

    <div class="panel-section drum-machine-panel">
  
      
<!-- Drum Machine Panel -->
  <div class="panel-section drum-machine-panel">
  
  <!-- Header with Clock Source -->
  <div class="drum-header">
    <h2 class="section-title">drum machine</h2>
    
    <div class="drum-clock-selector">
      <label>clock source</label>
      <select id="drumClockSource">
        <option value="transpose">Transpose Sequencer</option>
        <option value="rene">René Cycles</option>
        <option value="jf">Just Friends 4N</option>
      </select>
    </div>
    
    <div class="drum-clock-selector">
      <label>clock division</label>
      <select id="drumClockDivision">
        <option value="1">1×</option>
        <option value="2">2×</option>
        <option value="4" selected>4×</option>
        <option value="8">8×</option>
        <option value="16">16×</option>
      </select>
    </div>
  </div>
  
  <!-- Step Sequencers -->
  <div class="drum-sequencer-section">
    
    <!-- KICK SEQUENCER -->
    <div class="drum-seq-row">
      <div class="drum-seq-header">
        <span class="drum-seq-title">Kick</span>
        <button class="drum-seq-clear-btn" data-voice="kick">Clear</button>
      </div>
      <div class="drum-step-grid" id="drumKickSteps">
        <!-- Steps will be generated by JavaScript, but let's add placeholders -->
      </div>
    </div>
    
    <!-- SNARE SEQUENCER -->
    <div class="drum-seq-row">
      <div class="drum-seq-header">
        <span class="drum-seq-title">Snare</span>
        <button class="drum-seq-clear-btn" data-voice="snare">Clear</button>
      </div>
      <div class="drum-step-grid" id="drumSnareSteps">
        <!-- Steps will be generated by JavaScript -->
      </div>
    </div>
    
    <!-- HI-HAT SEQUENCER -->
    <div class="drum-seq-row">
      <div class="drum-seq-header">
        <span class="drum-seq-title">Hi-Hat</span>
        <button class="drum-seq-clear-btn" data-voice="hat">Clear</button>
      </div>
      <div class="drum-step-grid" id="drumHatSteps">
        <!-- Steps will be generated by JavaScript -->
      </div>
    </div>
    
  </div>
  
  <!-- Voice Parameter Sections -->
  <div class="drum-voices-container">
    
    <!-- KICK DRUM -->
    <div class="drum-voice-section" id="drumKickSection">
      <div class="drum-voice-header">
        <span class="drum-voice-title">Kick</span>
        <label class="drum-mute-toggle">
          <input type="checkbox" id="drumKickMute">
          <span>mute</span>
        </label>
      </div>
      
      <div class="drum-param-row">
        <label>pitch</label>
        <input type="range" id="drumKickPitch" min="20" max="200" step="1" value="30">
        <span class="drum-param-value" id="drumKickPitchValue">30 Hz</span>
      </div>
      
      <div class="drum-param-row">
        <label>decay</label>
        <input type="range" id="drumKickDecay" min="0.01" max="2" step="0.01" value="0.09">
        <span class="drum-param-value" id="drumKickDecayValue">0.09s</span>
      </div>
      
      <div class="drum-param-row">
        <label>drive</label>
        <input type="range" id="drumKickDrive" min="0" max="1" step="0.01" value="0">
        <span class="drum-param-value" id="drumKickDriveValue">0.00</span>
      </div>
      
      <div class="drum-param-row">
        <label>volume</label>
        <input type="range" id="drumKickVolume" min="0" max="1" step="0.01" value="0.80">
        <span class="drum-param-value" id="drumKickVolumeValue">0.80</span>
      </div>
    </div>
    
    <!-- SNARE DRUM -->
    <div class="drum-voice-section" id="drumSnareSection">
      <div class="drum-voice-header">
        <span class="drum-voice-title">Snare</span>
        <label class="drum-mute-toggle">
          <input type="checkbox" id="drumSnareMute">
          <span>mute</span>
        </label>
      </div>
      
      <div class="drum-param-row">
        <label>pitch</label>
        <input type="range" id="drumSnarePitch" min="100" max="500" step="1" value="142">
        <span class="drum-param-value" id="drumSnarePitchValue">142 Hz</span>
      </div>
      
      <div class="drum-param-row">
        <label>decay</label>
        <input type="range" id="drumSnareDecay" min="0.01" max="1" step="0.01" value="0.10">
        <span class="drum-param-value" id="drumSnareDecayValue">0.10s</span>
      </div>
      
      <div class="drum-param-row">
        <label>drive</label>
        <input type="range" id="drumSnareDrive" min="0" max="1" step="0.01" value="0">
        <span class="drum-param-value" id="drumSnareDriveValue">0.00</span>
      </div>
      
      <div class="drum-param-row">
        <label>volume</label>
        <input type="range" id="drumSnareVolume" min="0" max="1" step="0.01" value="0.60">
        <span class="drum-param-value" id="drumSnareVolumeValue">0.60</span>
      </div>
    </div>
    
    <!-- HI-HAT -->
    <div class="drum-voice-section" id="drumHatSection">
      <div class="drum-voice-header">
        <span class="drum-voice-title">Hi-Hat</span>
        <label class="drum-mute-toggle">
          <input type="checkbox" id="drumHatMute">
          <span>mute</span>
        </label>
      </div>
      
      <div class="drum-param-row">
        <label>decay</label>
        <input type="range" id="drumHatDecay" min="0.005" max="0.3" step="0.005" value="0.05">
        <span class="drum-param-value" id="drumHatDecayValue">0.05s</span>
      </div>
      
      <div class="drum-param-row">
        <label>tone</label>
        <input type="range" id="drumHatHPF" min="4000" max="12000" step="100" value="7000">
        <span class="drum-param-value" id="drumHatHPFValue">7000 Hz</span>
      </div>
      
      <div class="drum-param-row">
        <label>drive</label>
        <input type="range" id="drumHatDrive" min="0" max="1" step="0.01" value="0">
        <span class="drum-param-value" id="drumHatDriveValue">0.00</span>
      </div>
      
      <div class="drum-param-row">
        <label>volume</label>
        <input type="range" id="drumHatVolume" min="0" max="1" step="0.01" value="0.40">
        <span class="drum-param-value" id="drumHatVolumeValue">0.40</span>
      </div>
    </div>
    
  </div>
  
  <!-- Global Controls -->
  <div class="drum-global-controls">
    <button class="drum-control-btn" id="drumClearAll">Clear All Patterns</button>
    
    <div class="drum-control-group">
      <label>swing amount</label>
      <div class="drum-param-row">
        <input type="range" id="drumSwing" min="0" max="1" step="0.01" value="0">
        <span class="drum-param-value" id="drumSwingValue">0%</span>
      </div>
    </div>
    
    <div class="drum-control-group">
      <label>master volume</label>
      <div class="drum-param-row">
        <input type="range" id="drumMasterVolume" min="0" max="1" step="0.01" value="0.70">
        <span class="drum-param-value" id="drumMasterVolumeValue">0.70</span>
      </div>
    </div>
  </div>
  
</div> <!-- CLOSING TAG FOR drum-machine-panel -->

    <!-- JF #1 PANEL -->
    <div class="panel-section">
      <h2 class="section-title">just friends #1 (clock source)</h2>
      
      <div class="param-row">
        <label>time</label>
        <input type="range" id="jf1Time" min="0" max="1" step="0.01" value="0.25">
        <span class="param-value" id="jf1TimeValue">0.25</span>
      </div>
      
      <div class="param-row">
        <label>intone</label>
        <input type="range" id="jf1Intone" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="jf1IntoneValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>ramp</label>
        <input type="range" id="jf1Ramp" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="jf1RampValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>curve</label>
        <input type="range" id="jf1Curve" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="jf1CurveValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>mode</label>
        <select id="jf1Mode">
          <option value="0">transient</option>
          <option value="1">sustain</option>
          <option value="2" selected>cycle</option>
        </select>
      </div>
      
      <div class="param-row">
        <label>range</label>
        <select id="jf1Range">
          <option value="0" selected>shape</option>
          <option value="1">sound</option>
        </select>
      </div>
    </div>

    <!-- SCOPE 1 -->
    <div class="panel-section scope-panel">
      <h2 class="section-title">scope 1 (jf #1 identity)</h2>
      <canvas id="scope1" width="800" height="200"></canvas>
      <p class="scope-info">Clock source for transpose sequencer</p>
    </div>

    <!-- OSCILLATOR SELECTION PANEL -->
    <div class="panel-section oscillator-select-panel">
      <h2 class="section-title">oscillator selection</h2>
      
      <div class="osc-toggle-group">
        <button class="osc-toggle-btn active" data-osc="mangrove">
          <span class="osc-name">Mangrove A</span>
          <span class="osc-desc">Formant oscillator with FM</span>
        </button>
        <button class="osc-toggle-btn" data-osc="justfriends">
          <span class="osc-name">Just Friends Osc</span>
          <span class="osc-desc">6-slope waveshaper with RUN modes</span>
        </button>
      </div>

      <!-- FM ROUTING SECTION -->
      <div class="fm-toggle-section">
        <h3 class="section-title">fm routing (mangrove b)</h3>
        
        <div class="param-row fm-toggle-row">
          <label class="toggle-label">
            <input type="checkbox" id="fmEnable">
            <span class="toggle-text">Enable FM B → Active Oscillator</span>
          </label>
        </div>

        <div class="fm-mode-group">
          <button class="fm-mode-btn active" data-mode="exponential">
            <span class="fm-mode-name">Exponential FM</span>
            <span class="fm-mode-desc">Pitch modulation (1V/oct)</span>
          </button>
          <button class="fm-mode-btn" data-mode="linear">
            <span class="fm-mode-name">Linear FM</span>
            <span class="fm-mode-desc">Through-zero FM</span>
          </button>
        </div>
      </div>
    </div>

    <!-- MANGROVE A PANEL -->
    <div class="panel-section" id="mangrovePanel">
      <h2 class="section-title">mangrove a (main voice)</h2>
      
      <div class="param-row">
        <label>pitch</label>
        <input type="range" id="maPitch" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="maPitchValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>barrel</label>
        <input type="range" id="maBarrel" min="0" max="1" step="0.01" value="0.3">
        <span class="param-value" id="maBarrelValue">0.30</span>
      </div>
      
      <div class="param-row">
        <label>formant</label>
        <input type="range" id="maFormant" min="0" max="1" step="0.01" value="0.6">
        <span class="param-value" id="maFormantValue">0.60</span>
      </div>
      
      <div class="param-row">
        <label>air</label>
        <input type="range" id="maAir" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="maAirValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>fm depth</label>
        <input type="range" id="maFmIndex" min="0" max="1" step="0.01" value="0.3">
        <span class="param-value" id="maFmIndexValue">0.30</span>
      </div>
    </div>

    <!-- JUST FRIENDS OSC PANEL (hidden by default) -->
    <div class="panel-section" id="jfOscPanel" style="display: none;">
      <h2 class="section-title">
        just friends osc
        <span class="mode-badge" id="jfOscModeBadge">cycle/sound</span>
      </h2>
      
      <div class="jfosc-mode-controls">
        <select id="jfOscMode">
          <option value="0">transient</option>
          <option value="1">sustain</option>
          <option value="2" selected>cycle</option>
        </select>
        
        <select id="jfOscRange">
          <option value="0">shape</option>
          <option value="1" selected>sound</option>
        </select>
        
        <label class="toggle-label">
          <input type="checkbox" id="jfOscRunToggle">
          <span class="toggle-text">RUN</span>
        </label>
      </div>
      
      <div class="param-row">
        <label>time</label>
        <input type="range" id="jfOscTime" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="jfOscTimeValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>intone</label>
        <input type="range" id="jfOscIntone" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="jfOscIntoneValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>ramp</label>
        <input type="range" id="jfOscRamp" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="jfOscRampValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>curve</label>
        <input type="range" id="jfOscCurve" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="jfOscCurveValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>fm index</label>
        <input type="range" id="jfOscFmIndex" min="-1" max="1" step="0.01" value="0">
        <span class="param-value" id="jfOscFmIndexValue">0.00</span>
      </div>
      
      <div class="param-row">
        <label>run</label>
        <input type="range" id="jfOscRun" min="-1" max="1" step="0.01" value="0">
        <span class="param-value" id="jfOscRunValue">0.00</span>
      </div>

      <div class="jfosc-triggers">
        <h3 class="section-title">triggers</h3>
        <div class="trigger-group">
          <button class="jfosc-trigger-btn" data-index="0">1N</button>
          <button class="jfosc-trigger-btn" data-index="1">2N</button>
          <button class="jfosc-trigger-btn" data-index="2">3N</button>
          <button class="jfosc-trigger-btn" data-index="3">4N</button>
          <button class="jfosc-trigger-btn" data-index="4">5N</button>
          <button class="jfosc-trigger-btn" data-index="5">6N</button>
        </div>
      </div>
    </div>

    <!-- MANGROVE B PANEL -->
    <div class="panel-section">
      <h2 class="section-title">mangrove b (fm modulator)</h2>
      
      <div class="param-row">
        <label>pitch</label>
        <input type="range" id="mbPitch" min="0" max="1" step="0.01" value="0.52">
        <span class="param-value" id="mbPitchValue">0.52</span>
      </div>
      
      <div class="param-row">
        <label>barrel</label>
        <input type="range" id="mbBarrel" min="0" max="1" step="0.01" value="0.65">
        <span class="param-value" id="mbBarrelValue">0.65</span>
      </div>
      
      <div class="param-row">
        <label>formant</label>
        <input type="range" id="mbFormant" min="0" max="1" step="0.01" value="0.55">
        <span class="param-value" id="mbFormantValue">0.55</span>
      </div>
    </div>

    <!-- MANGROVE C PANEL -->
    <div class="panel-section">
      <h2 class="section-title">mangrove c (filter fm)</h2>
      
      <div class="param-row">
        <label>pitch</label>
        <input type="range" id="mcPitch" min="0" max="1" step="0.01" value="0.6">
        <span class="param-value" id="mcPitchValue">0.60</span>
      </div>
      
      <div class="param-row">
        <label>barrel</label>
        <input type="range" id="mcBarrel" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="mcBarrelValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>formant</label>
        <input type="range" id="mcFormant" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="mcFormantValue">0.50</span>
      </div>
    </div>

    <!-- THREE SISTERS PANEL -->
    <div class="panel-section">
      <h2 class="section-title">three sisters</h2>
      
      <div class="param-row">
        <label>freq</label>
        <input type="range" id="tsFreq" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="tsFreqValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>span</label>
        <input type="range" id="tsSpan" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="tsSpanValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>quality</label>
        <input type="range" id="tsQuality" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="tsQualityValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>fm atten</label>
        <input type="range" id="tsFmAtten" min="0" max="1" step="0.01" value="0.5">
        <span class="param-value" id="tsFmAttenValue">0.50</span>
      </div>
      
      <div class="param-row">
        <label>mode</label>
        <select id="tsMode">
          <option value="0">crossover</option>
          <option value="1">formant</option>
        </select>
      </div>
    </div>

    <!-- SCOPE 2 - MOVED HERE (after Three Sisters, before modulation matrix) -->
    <div class="panel-section scope-panel">
      <h2 class="section-title">scope 2 (three sisters output)</h2>
      <canvas id="scope2" width="800" height="200"></canvas>
      <p class="scope-info">Final audio output</p>
    </div>

    <!-- MODULATION MATRIX PANEL -->
    <div class="panel-section mod-matrix-panel">
      <h2 class="section-title">modulation matrix (jf #1 slopes)</h2>
      
      <div class="mod-matrix-hint">
        <p><strong>Route JF #1 slopes (2N-6N) to any parameter.</strong></p>
        <p>Each slope can modulate a different destination with independent depth, offset, and polarity control.</p>
      </div>
      
      <div class="mod-slots-container" id="modSlotsContainer">
        <!-- Modulation slots generated by JavaScript -->
      </div>
    </div>

    <!-- LFO PANEL - Add this after the modulation matrix panel in index.html -->

    <!-- 7 LFO MODULATION PANEL -->
    <div class="panel-section lfo-panel">
      <h2 class="section-title">lfo modulation (7 independent lfos)</h2>
      
      <div class="mod-matrix-hint">
        <p><strong>7 independent LFOs with dual destinations.</strong></p>
        <p>Each LFO can modulate two different parameters simultaneously with independent depth, offset, and polarity control.</p>
        <p>LFOs can modulate nearly every parameter in the system, including other LFOs for complex modulation.</p>
      </div>
      
      <div class="lfo-grid" id="lfoGridContainer">
        <!-- 7 LFO modules generated by JavaScript -->
      </div>
    </div>

        <!-- EFFECTS CHAIN PANEL -->
    <div class="panel-section effects-chain-panel">
      <h2 class="section-title">effects chain (synth only)</h2>
      <div id="effectsContainer" class="effects-container">
        <!-- Effects will be generated by JavaScript -->
      </div>
    </div>

<!-- IMPORTANT: In the <head> section, add: -->
<!-- <link rel="stylesheet" href="lfo-styles.css"> -->

<!-- IMPORTANT: In the main.js import, replace the import line with: -->
<!-- <script type="module" src="./main-with-lfos.js"></script> -->

    <!-- MASTER CONTROLS -->
    <div class="panel-section">
      <h2 class="section-title">master</h2>
      
      <div class="param-row">
        <label>volume</label>
        <input type="range" id="masterVolume" min="0" max="1" step="0.01" value="0.3">
        <span class="param-value" id="masterVolumeValue">0.30</span>
      </div>
      
      <button class="action-btn" id="startBtn" disabled>
        <span class="btn-icon">▶</span> Start Audio
      </button>
    </div>
  </div>

  <div class="footer">
    <div class="footer-hint">
      Phase 5 - Modular synthesis system with transpose sequencing
    </div>
  </div>

  <script type="module" src="./main.js"></script>
  <script src="./transport-init.js"></script>
</body>
</html>
